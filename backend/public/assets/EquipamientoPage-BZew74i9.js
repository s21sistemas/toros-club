import{h as S,e as b,n as M,u as k,k as R,d as B,o as Y,i as A,f as T,t as E,r as I,j as n}from"./index-CjWeqAa0.js";import{B as J,a as L}from"./ButtonsModal-C4PNvLzT.js";import{B as z}from"./BaseTable-DxRxbJEJ.js";import{M as G}from"./ModalDelete-DpY_EDEH.js";import{w as K,u as q,a as N,I as g}from"./InputField-C2bV7C3J.js";import{S as j}from"./sweetalert2.esm.all-B0Dix5B2.js";import{r as F,s as H}from"./almacen-CwI6MNzI.js";import{d as v}from"./dayjs.min-DH9acFiI.js";import{u as Q}from"./usePaymentPlayerStore-pMws1P9d.js";import{A as y}from"./AlertaCard-CMccITvI.js";import{C as U}from"./CancelButtonModal-BD6jH3B7.js";import"./chevron-right-CCqFvTGw.js";import"./players-FXc4Iomq.js";import"./costos-porrista-9QLCd6eY.js";import"./es-Om7KOudh.js";import"./square-pen-BYxR8_4Y.js";import"./eye-BbsgsaIk.js";import"./categorias-DYCwzMem.js";import"./caja-CQ-B0I8H.js";import"./historial-DbYVCKzn.js";const O=B(b,"equipamiento"),V=async t=>{try{return await F(t.equipamiento_asignado)?(await R(O,t)).id:null}catch(e){throw console.error("Error al agregar equipamiento:",e),e}},W=async t=>Y(O,e=>{const s=e.docs.map(a=>{var l;const r=a.data(),u=((l=r==null?void 0:r.jugadorId)==null?void 0:l.label)||"Sin asignar",c=Object.entries(r).filter(([i,d])=>d===!0&&i!=="devuelto").map(([i])=>i.replace(/_/g," ")).join(", ");return{id:a.id,...a.data(),equipo_prestado:c,jugador:u}});t(s)}),X=async(t,e)=>{try{const s=S(b,"equipamiento",t),a=await M(s),r=a.exists()?a.data():{},u=r.equipamiento_asignado||[],c=e.equipamiento_asignado||[],l=e.devuelto==="SI"&&r.devuelto!=="SI",i=c.filter(d=>!u.some(p=>p.label===d.label));return i.length>0&&!await F(i)?null:(l&&await H(u),delete e.equipo_prestado,delete e.jugador,await k(s,e),!0)}catch(s){console.error("Error al actualizar equipamiento:",s)}},Z=async t=>{try{const e=S(b,"equipamiento",t);await A(e)}catch(e){console.error("Error al eliminar equipamiento:",e)}},x=t=>t.reduce((e,s)=>(e[s]=!0,e),{casco:!1,hombreras:!1,guardas:!1,uniforme_entrenamiento:!1,jersey:!1,shorts:!1,leggings:!1});let w=null,D=null;const m=T((t,e)=>({equipamiento:[],loading:!1,getDataEquipo:async()=>(t({loading:!0}),new Promise((s,a)=>{try{w?s(e().equipo):w=K(r=>{t({equipo:r}),s(r)})}catch(r){console.error(r),a(r)}finally{t({loading:!1})}})),getDataEquipamiento:async()=>(t({loading:!0}),new Promise((s,a)=>{try{D?s(e().equipamiento):D=W(r=>{t({equipamiento:r}),s(r)})}catch(r){console.error(r),a(r)}finally{t({loading:!1})}})),addEquipamiento:async s=>{try{const a=s.equipamiento_asignado.map(l=>l.label.toLowerCase().replace(/\s+/g,"_")),r=x(a),u={...s,...r,devuelto:"NO",fecha_asignacion:v().format("DD/MM/YYYY")};if(!await V(u))throw new Error("No se pudo guardar el registro");E.success("Registro creado correctamente")}catch(a){throw console.error(a),a}},editEquipamiento:async s=>{try{const a=s.equipamiento_asignado.map(l=>l.label.toLowerCase().replace(/\s+/g,"_")),r=x(a),u={...s,...r,fecha_asignacion:v().format("DD/MM/YYYY")};if(!await X(u.id,u))throw new Error("No se pudo guardar el registro");E.success("Actualizado correctamente")}catch(a){throw console.error(a),a}},deleteEquipamiento:async s=>{const a=async()=>{try{await Z(s)}catch(r){console.error(r)}};E.promise(a(),{loading:"Eliminando...",success:"Eliminado correctamente",error:"Falló al eliminar."})}})),C=()=>{const t=q(o=>o.modalType),e=q(o=>o.formData),s=q(o=>o.closeModal),a=q(o=>o.setFormData),r=m(o=>o.loading),u=m(o=>o.equipamiento),c=m(o=>o.getDataEquipamiento),l=m(o=>o.addEquipamiento),i=m(o=>o.editEquipamiento),d=m(o=>o.deleteEquipamiento),p=Q(o=>o.getDataPaymentsPlayer),P=m(o=>o.getDataEquipo);return I.useEffect(()=>{e.numero_serie_casco||a("numero_serie_casco",null),e.numero_serie_hombreras||a("numero_serie_hombreras",null),e.numero_serie_jersey||a("numero_serie_jersey",null),e.talla_jersey||a("talla_jersey",null),e.numero_serie_funda||a("numero_serie_funda",null),e.talla_funda||a("talla_funda",null)},[e.numero_serie_casco,e.numero_serie_funda,e.numero_serie_hombreras,e.numero_serie_jersey,e.talla_funda,e.talla_jersey,a]),{equipamiento:u,loading:r,getDataEquipamiento:c,handleSubmit:async o=>{o.preventDefault(),j.fire({title:'<h2 style="font-family: "sans-serif";">Guardando registro, por favor espere...</h2>',allowEscapeKey:!1,allowOutsideClick:!1,timerProgressBar:!0,didOpen:()=>{j.showLoading()}});try{t==="add"?await l(e):t==="edit"&&await i(e),s()}catch(f){console.log(f)}finally{j.close()}},handleDelete:o=>{d(o),s()},loadOptionsPlayer:async()=>{try{return(await p()).filter(_=>_.inscripcion==="pagado").map(_=>_.jugador)}catch(o){return console.error("Error loading users:",o),[]}},loadOptionsEquipo:async()=>{try{return(await P()).map(f=>({value:f.id,label:f.nombre}))}catch(o){return console.error("Error loading equipos:",o),[]}}}},h={jugadorFields:[{required:!0,type:"async",label:"Selecciona al jugador *",name:"jugadorId",note:"Si el jugador no se muestra es porque no ha pagado la inscripción."},{required:!0,type:"date",label:"Fecha de la entrega *",name:"fecha_entrega"}],generalFields:[{required:!0,type:"text",label:"Número del equipamiento *",name:"numero"},{required:!0,type:"async-multi",label:"Equipamiento *",name:"equipamiento_asignado"}],opcSelect:[{value:"",label:"Selecciona una opción"},{value:"SI",label:"SI"},{value:"NO",label:"NO"}],aplicaFields:[{required:!1,type:"text",label:"Número de serie del casco",name:"numero_serie_casco"},{required:!1,type:"text",label:"Número de serie de las hombreras",name:"numero_serie_hombreras"},{required:!1,type:"text",label:"Número de serie del Jersey",name:"numero_serie_jersey"},{required:!1,type:"text",label:"Talla del Jersey",name:"talla_jersey"},{required:!1,type:"text",label:"Número de serie de la funda",name:"numero_serie_funda"},{required:!1,type:"text",label:"Talla de la funda",name:"talla_funda"}]},$=()=>{const{view:t,formData:e,document:s,handleInputChange:a}=N(),{loadOptionsPlayer:r,loadOptionsEquipo:u}=C();return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6",children:[n.jsx("div",{className:"md:col-span-6 sm:col-span-6",children:n.jsx(y,{text:"Jugador"})}),h.jugadorFields.map(({type:c,label:l,name:i,required:d,note:p})=>n.jsx(g,{type:c,label:l,name:i,note:p,required:d,value:e[i]||"",onChange:a,disabled:t||e.devuelto==="SI",loadOptions:r,classInput:"md:col-span-3"},i)),n.jsx("div",{className:"md:col-span-6 sm:col-span-6",children:n.jsx(y,{text:"Selecciona el equipo prestado"})}),h.generalFields.map(({type:c,label:l,name:i,required:d})=>n.jsx(g,{type:c,label:l,name:i,required:d,value:e[i]||"",onChange:a,disabled:t||e.devuelto==="SI",loadOptions:u,classInput:"md:col-span-3"},i)),n.jsx("div",{className:"md:col-span-6 sm:col-span-6",children:n.jsx(y,{text:"Rellenar los datos si es que aplica"})}),h.aplicaFields.map(({type:c,label:l,name:i,required:d})=>n.jsx(g,{type:c,label:l,name:i,required:d,value:e[i]||"",onChange:a,disabled:t||e.devuelto==="SI",classInput:"md:col-span-3"},i)),s&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"md:col-span-6 sm:col-span-6",children:n.jsx(y,{text:"¿Equipo devuelto?"})}),n.jsx(g,{type:"select",label:"Selecciona si ya se devolvió el equipo *",name:"devuelto",required:!0,value:e.devuelto||"",onChange:a,disabled:t||e.devuelto==="SI",opcSelect:h.opcSelect,classInput:["SI"].includes(e.devuelto)?"md:col-span-3":"md:col-span-6"}),e.devuelto==="SI"&&n.jsx(g,{type:"date",label:"Fecha en la que se devolvió el equipo *",name:"fecha_devuelto",required:!0,disabled:t,value:e.fecha_devuelto||"",onChange:a,classInput:"md:col-span-3"})]})]}),t?n.jsx(U,{}):n.jsx(J,{})]})},ee=[{key:"jugador",name:"Jugador"},{key:"equipo_prestado",name:"Equipo prestado"},{key:"devuelto",name:"¿Ya fue devuelto?"}];function we(){const{modalType:t,currentItem:e}=N(),{equipamiento:s,loading:a,getDataEquipamiento:r,handleSubmit:u,handleDelete:c}=C();return I.useEffect(()=>{(async()=>await r())()},[r]),n.jsxs("div",{className:"md:p-4 bg-gray-100",children:[n.jsx(z,{columns:ee,data:s,title:"Asignación de equipamiento",loading:a}),(t==="add"||t==="edit"||t==="view")&&n.jsx(L,{handleSubmit:u,Inputs:n.jsx($,{})}),t==="delete"&&e&&n.jsx(G,{handleDelete:c})]})}export{we as default};
